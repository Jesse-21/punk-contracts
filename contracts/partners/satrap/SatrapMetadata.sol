// SPDX-License-Identifier: GPL-3.0-or-later
pragma solidity ^0.8.4;

import "base64-sol/base64.sol";
import "@openzeppelin/contracts/access/Ownable.sol";
import "@openzeppelin/contracts/utils/Strings.sol";
import "../../lib/strings.sol";

/// @title .satrap domain metadata contract
/// @author Tempe Techie
/// @notice Contract that stores metadata for the .satrap TLD
contract SatrapMetadata is Ownable {
  using Strings for uint256;

  string public description = "Satraps usernames and identity. Powered by Songbird Domains and the Punk Domains protocol.";

  // EVENTS
  event DescriptionChanged(address indexed user, string description);

  // READ
  function getMetadata(string calldata _domainName, string calldata _tld, uint256 _tokenId) public view returns(string memory) {
    string memory fullDomainName = string(abi.encodePacked(_domainName, _tld));
    uint256 domainLength = strings.len(strings.toSlice(_domainName));
    string memory hue = _randomHueNum(_tokenId).toString();

    return string(
      abi.encodePacked("data:application/json;base64,", Base64.encode(bytes(abi.encodePacked(
        '{"name": "', fullDomainName, '", ',
        '"description": "', description, '", ',
        '"attributes": [',
          '{"trait_type": "length", "value": "', Strings.toString(domainLength) ,'"}, ',
          '{"trait_type": "hue", "value": "', hue ,'"}',
        '], '
        '"image": "', _getImage(fullDomainName, hue), '"}'))))
    );
  } 

  function _getImage(
    string memory _fullDomainName,
    string memory _hue
  ) internal pure returns (string memory) {
    string memory svgBase64Encoded = Base64.encode(bytes(string(abi.encodePacked(
      '<svg class="cls-1" width="500" height="500" viewBox="0 0 500 500" xmlns="http://www.w3.org/2000/svg">',
        '<defs><style>.cls-1{background-color:hsl(',_hue,', 50%, 40%)} .cls-2{fill:#000}</style></defs>',
        '<g class="cls-2" transform="translate(0.000000,500.000000) scale(0.098814,-0.101215)">',
          '<path d="M2465 4851 c-48 -12 -74 -29 -91 -62 -11 -23 -20 -29 -32 -23 -44 19 -95 16 -163 -11 -38 -15 -66 -32 -63 -36 3 -5 -2 -6 -10 -3 -9 3 -16 2 -16 -3 0 -15 -41 -30 -142 -54 -153 -35 -328 -142 -420 -257 -21 -26 -52 -64 -69 -85 -39 -48 -91 -162 -115 -251 -10 -38 -32 -90 -48 -116 -17 -25 -37 -55 -44 -65 -7 -11 -21 -33 -32 -50 -11 -16 -20 -37 -20 -45 0 -17 213 -289 237 -303 27 -16 12 -42 -38 -65 -27 -13 -83 -54 -123 -90 -40 -37 -96 -88 -124 -113 -45 -40 -52 -52 -52 -84 0 -28 6 -42 27 -58 25 -21 58 -54 143 -149 25 -28 49 -42 84 -51 42 -11 53 -19 72 -52 25 -45 78 -74 136 -75 40 0 78 -27 78 -55 0 -8 -12 -22 -26 -32 -67 -47 -96 -76 -81 -84 9 -6 13 -24 12 -56 -1 -26 3 -54 8 -60 5 -7 6 -13 1 -13 -5 0 -2 -5 6 -10 8 -5 10 -10 4 -10 -7 0 -22 8 -35 19 -22 17 -22 19 -6 35 9 10 16 25 16 34 -1 15 -2 15 -6 0 -6 -23 -22 -23 -38 -1 -9 12 -10 23 -4 35 5 10 6 18 2 18 -4 0 -1 5 7 10 13 8 13 10 -2 10 -9 0 -20 -4 -23 -10 -3 -5 -1 -10 6 -10 7 0 4 -6 -6 -14 -11 -8 -24 -12 -28 -9 -5 3 -6 -5 -2 -17 6 -18 4 -22 -9 -17 -8 3 -18 1 -22 -5 -4 -7 -3 -8 4 -4 16 10 15 -7 0 -23 -11 -11 -9 -11 10 -2 12 7 22 8 21 4 -1 -4 0 -12 1 -18 5 -16 11 -125 10 -186 0 -43 6 -65 24 -91 21 -31 24 -50 29 -174 6 -142 20 -216 59 -301 12 -27 21 -60 19 -74 -1 -15 5 -68 14 -119 9 -50 18 -117 20 -148 2 -31 6 -69 10 -84 12 -47 -13 -134 -49 -173 -54 -57 -118 -41 -85 22 16 29 48 64 73 78 26 15 13 51 -22 59 -18 4 -40 25 -67 62 -39 55 -71 82 -83 69 -8 -7 -6 -56 5 -175 8 -86 17 -115 33 -105 5 3 11 -27 14 -67 6 -88 6 -76 0 -168 -4 -54 0 -101 15 -170 23 -103 26 -155 11 -165 -6 -4 -10 -95 -10 -241 l0 -234 31 0 31 0 -3 69 -4 69 73 78 c75 81 85 102 52 111 -23 6 -26 26 -5 43 19 15 52 4 71 -24 11 -19 12 -29 3 -52 -7 -20 -8 -72 -4 -161 l7 -132 32 -3 c17 -2 412 -2 877 0 l845 2 2 198 c1 108 5 230 9 270 l8 72 30 -21 c34 -25 92 -110 115 -169 35 -89 73 -127 248 -240 l167 -110 141 0 c133 0 142 1 161 23 14 14 23 41 27 77 11 114 23 196 34 240 6 25 16 88 22 141 8 77 7 107 -5 152 -11 41 -12 69 -6 104 10 54 5 98 -15 128 -8 11 -14 46 -14 84 0 43 -6 78 -19 105 -35 74 -91 275 -101 367 -11 94 -24 129 -69 189 -39 52 -80 270 -87 465 -7 199 -13 189 196 329 89 60 202 145 250 190 48 45 115 98 149 120 69 42 115 98 131 158 6 22 17 38 25 38 9 0 28 18 43 40 15 22 39 45 55 52 15 7 27 16 27 20 0 19 -42 48 -69 48 -24 0 -30 -5 -34 -27 -7 -43 -41 -128 -52 -132 -5 -2 -38 -33 -72 -69 l-62 -66 -7 28 c-5 23 -1 33 22 55 73 71 134 141 135 158 1 10 2 38 3 63 1 25 6 55 10 67 11 33 -56 162 -121 237 -38 43 -58 106 -74 238 -16 133 -9 161 44 190 46 26 56 48 36 85 -20 38 -52 45 -119 28 -32 -8 -83 -15 -115 -15 -84 0 -115 -20 -115 -77 0 -57 -7 -64 -59 -57 -55 7 -87 -14 -78 -50 3 -12 10 -39 16 -61 6 -22 11 -68 11 -103 l0 -63 -76 -80 c-46 -49 -85 -101 -102 -136 -33 -74 -41 -172 -18 -239 9 -26 16 -63 16 -81 0 -19 4 -42 10 -52 7 -14 4 -24 -15 -41 -24 -23 -52 -87 -42 -96 3 -3 24 11 47 32 34 30 43 35 51 23 16 -26 9 -58 -22 -94 -37 -41 -48 -43 -86 -11 l-28 23 -69 -28 c-68 -27 -129 -69 -150 -101 -7 -12 -6 -21 3 -32 12 -14 18 -12 56 23 55 51 111 68 164 53 75 -23 70 -33 -49 -98 -60 -32 -110 -64 -110 -69 0 -6 -18 -28 -40 -49 -39 -37 -41 -41 -38 -90 2 -42 6 -51 23 -54 16 -2 27 13 55 70 43 88 75 128 103 128 18 0 173 92 187 112 3 4 43 21 89 38 69 25 92 29 132 24 51 -7 70 1 90 38 9 16 2 22 -53 48 -35 17 -78 30 -95 30 -20 0 -33 5 -33 13 0 7 -27 41 -60 75 -81 85 -93 110 -98 213 -5 95 7 146 40 175 l21 19 -7 -75 c-8 -94 5 -142 69 -244 l47 -76 57 0 c43 -1 68 -7 106 -29 48 -27 50 -29 48 -70 -1 -29 2 -41 10 -38 21 6 107 141 107 168 0 14 6 34 14 44 13 18 14 18 21 -4 15 -49 -14 -137 -76 -227 -15 -22 -31 -52 -34 -65 -11 -43 -162 -159 -207 -159 -10 0 -22 -9 -28 -21 -6 -11 -43 -40 -81 -65 -38 -25 -89 -63 -114 -84 -55 -48 -85 -65 -106 -62 -13 2 -17 -12 -23 -85 -7 -94 9 -181 33 -175 7 1 10 -2 6 -7 -3 -6 1 -21 9 -33 24 -37 40 -147 32 -221 -7 -62 -10 -67 -34 -73 -15 -3 -33 -8 -41 -10 -8 -3 -60 -5 -115 -5 -96 0 -100 1 -123 27 l-23 27 0 343 c0 252 -3 350 -12 371 -11 23 -14 -36 -18 -352 -3 -209 -9 -388 -14 -397 -4 -10 -14 -18 -22 -18 -16 0 -51 35 -68 70 -21 40 -54 151 -61 205 -9 66 -23 89 -93 159 -38 37 -71 60 -93 65 -25 5 -35 14 -44 41 -10 30 -17 35 -66 46 -30 7 -83 24 -119 37 -36 14 -85 28 -110 32 -35 6 -57 18 -100 60 -45 42 -64 53 -103 59 -26 4 -52 4 -57 1 -13 -8 -110 62 -110 79 0 6 -13 23 -30 38 -34 30 -36 47 -15 108 8 23 15 63 15 89 0 26 7 56 16 69 14 21 22 22 145 22 208 0 229 16 229 180 0 128 16 271 30 280 7 4 9 25 5 56 -6 49 -6 49 32 69 50 26 54 57 13 108 -36 42 -50 40 -50 -7 0 -45 -14 -54 -90 -60 -43 -3 -66 -10 -72 -21 -5 -8 -14 -13 -19 -10 -5 4 -7 10 -4 15 3 5 2 11 -3 14 -4 2 -9 -4 -9 -15 -2 -17 8 -24 30 -20 4 0 7 -5 7 -13 0 -8 16 -18 38 -23 34 -8 37 -12 37 -43 0 -29 -4 -36 -24 -38 -13 -2 -46 -20 -74 -39 -41 -29 -55 -34 -82 -29 -27 5 -35 3 -39 -12 -12 -36 3 -52 48 -52 44 0 63 -13 99 -72 10 -16 22 -28 29 -28 15 0 47 -39 54 -66 10 -40 -1 -68 -35 -91 -42 -28 -84 -29 -153 -3 -38 14 -75 19 -131 18 -64 -1 -82 2 -105 19 -37 27 -94 43 -155 43 -60 0 -115 27 -156 77 -37 45 -73 134 -60 148 5 5 9 34 9 65 0 63 11 80 52 80 21 0 28 -5 28 -19 0 -27 26 -44 60 -39 18 3 35 -1 41 -9 13 -15 94 -17 188 -3 62 9 67 11 122 71 l57 62 -5 56 c-3 32 -13 68 -25 84 l-19 28 36 15 c43 17 52 36 36 71 -10 23 -10 28 6 36 34 20 63 57 63 82 0 49 39 22 77 -55 22 -43 34 -56 54 -58 39 -5 54 20 34 57 -14 28 -14 34 0 61 20 39 19 79 -5 149 -18 55 -19 62 -4 106 10 27 14 63 11 86 -6 47 -62 126 -116 163 -33 23 -44 39 -61 94 -12 36 -30 78 -41 93 -10 15 -19 33 -19 39 0 7 -12 24 -26 39 -14 14 -46 54 -70 88 -58 82 -121 112 -199 94z m245 -376 c15 -18 3 -38 -17 -31 -19 8 -104 -26 -237 -94 -97 -48 -136 -60 -136 -40 0 10 122 112 127 106 10 -10 98 17 126 37 18 14 37 23 43 20 6 -2 22 1 35 6 34 14 45 13 59 -4z m113 -145 c23 -30 41 -66 46 -94 5 -26 21 -64 36 -85 30 -44 47 -104 39 -137 -6 -23 -42 -44 -77 -44 -12 0 -42 7 -67 16 -29 10 -59 13 -87 9 -51 -7 -140 -38 -156 -54 -13 -13 -34 -14 -42 -2 -3 6 26 45 65 88 39 43 77 92 84 109 9 19 31 41 57 55 55 30 59 53 19 107 -16 23 -30 51 -30 62 0 17 6 20 38 20 32 -1 42 -7 75 -50z m1700 -810 c47 0 50 -24 4 -39 -29 -10 -75 -51 -146 -133 l-23 -26 33 -17 c34 -18 137 -27 141 -13 2 5 26 11 54 14 44 6 54 4 72 -16 12 -13 25 -35 31 -51 8 -25 5 -33 -30 -72 -21 -25 -39 -55 -39 -66 0 -18 -6 -21 -43 -21 -23 0 -60 -9 -81 -19 -50 -26 -83 -14 -134 47 -51 61 -62 84 -62 124 0 25 -6 36 -22 43 -23 10 -33 42 -12 38 6 -1 10 8 10 20 -1 13 4 21 12 19 8 -1 11 2 6 9 -8 14 42 59 67 59 26 0 34 19 13 35 -16 11 -17 16 -5 39 16 30 33 36 81 30 19 -2 52 -4 73 -4z m-2313 -432 c11 -7 20 -21 20 -30 0 -29 56 -83 122 -118 34 -18 81 -51 105 -73 65 -60 114 -173 83 -192 -5 -3 -10 -17 -10 -29 0 -93 -135 -104 -432 -34 -76 17 -138 35 -138 40 0 24 43 67 115 113 115 75 129 93 121 151 -3 26 -17 72 -31 102 -19 42 -24 64 -19 91 10 54 16 59 31 23 7 -17 22 -37 33 -44z m675 -747 c3 -10 3 -26 -1 -35 -4 -10 0 -22 9 -29 9 -7 23 -41 32 -77 9 -36 23 -72 30 -80 8 -8 15 -35 17 -60 3 -41 5 -45 32 -48 27 -3 28 -4 21 -49 -7 -47 -30 -93 -46 -93 -18 0 -8 38 11 43 43 11 10 67 -40 67 -19 0 -35 -9 -48 -25 -22 -28 -32 -31 -50 -13 -9 9 -3 29 28 86 22 40 40 77 40 82 0 4 -13 13 -29 18 -25 9 -30 17 -36 62 -7 51 -8 52 -36 46 -39 -7 -38 14 1 77 31 49 55 60 65 28z m-1290 -42 c96 -98 266 -168 473 -195 64 -9 131 -20 148 -25 45 -13 80 -11 94 6 19 23 168 21 177 -2 4 -10 -2 -23 -15 -34 -12 -9 -22 -22 -22 -27 0 -6 -30 -27 -67 -47 -75 -41 -213 -136 -213 -147 0 -4 9 -10 20 -13 14 -5 32 1 53 18 18 13 51 34 75 46 24 12 60 37 80 55 20 18 51 38 68 45 18 7 44 26 60 42 15 16 33 29 40 29 75 0 -86 -191 -190 -226 -25 -9 -65 -33 -89 -55 -36 -31 -53 -39 -84 -39 -40 0 -164 -58 -171 -80 -5 -15 16 -30 43 -30 11 0 52 16 90 35 39 19 82 37 97 40 15 3 48 23 74 46 26 22 70 51 98 64 56 26 127 89 150 134 19 36 104 91 140 91 62 0 85 -39 45 -74 -16 -13 -20 -25 -15 -46 8 -42 -8 -45 -55 -10 -23 16 -48 30 -56 30 -16 0 -73 -117 -73 -151 0 -14 -7 -35 -16 -47 -14 -20 -14 -22 1 -22 9 0 33 9 53 19 35 18 51 39 66 84 4 12 14 17 28 15 25 -3 35 -39 24 -83 -6 -24 -164 -165 -199 -178 -12 -4 -38 -25 -57 -45 -20 -20 -49 -45 -65 -55 -17 -9 -45 -28 -64 -42 -19 -14 -44 -25 -57 -25 -13 0 -28 -8 -33 -19 -6 -10 -23 -21 -38 -24 -20 -4 -32 -15 -40 -37 -11 -28 -15 -31 -42 -25 -16 3 -32 2 -36 -4 -3 -6 -36 -28 -73 -50 -52 -30 -82 -41 -132 -46 -36 -3 -75 -11 -87 -17 -33 -16 -92 -1 -105 27 -10 22 -7 28 18 52 24 22 42 28 109 34 83 7 244 57 323 100 48 26 55 54 17 71 -14 6 -25 17 -25 24 0 8 -26 27 -57 43 -99 49 -95 50 -131 -26 -43 -95 -86 -150 -122 -158 -26 -6 -35 0 -89 57 -34 35 -60 72 -61 84 0 19 7 22 75 27 42 4 106 17 143 30 62 21 67 25 67 52 0 40 -31 44 -94 12 -26 -14 -69 -28 -97 -32 -27 -4 -58 -15 -69 -25 -15 -13 -26 -16 -43 -9 -27 10 -36 31 -28 64 6 24 9 25 86 25 49 0 80 4 80 11 0 17 64 38 163 53 72 11 100 20 119 38 14 12 36 30 48 38 12 9 21 23 19 32 -3 14 -29 7 -169 -47 -142 -54 -178 -64 -256 -70 l-90 -7 -28 133 c-16 74 -31 173 -35 220 -4 52 -12 93 -21 104 -8 9 -13 30 -12 46 1 17 -4 55 -12 86 -8 31 -13 60 -10 65 11 18 41 6 79 -33z m729 -74 c11 -42 45 -51 99 -26 31 14 56 19 74 15 59 -14 52 -24 -35 -50 -55 -16 -178 -21 -253 -10 -92 14 -99 17 -99 37 0 29 23 33 69 10 55 -28 66 -27 98 14 33 42 39 43 47 10z m616 -448 c0 -26 -32 -57 -60 -57 -25 0 -38 -26 -37 -73 1 -49 -20 -70 -75 -71 l-43 -1 -3 -42 c-3 -40 -5 -43 -33 -43 -24 0 -29 4 -25 18 3 9 8 29 11 43 9 37 226 246 258 248 4 1 7 -9 7 -22z m-237 -394 c-7 -50 -29 -92 -50 -93 -7 0 -13 -4 -13 -9 0 -14 -76 -41 -114 -41 -26 0 -41 -8 -60 -31 -14 -17 -26 -37 -26 -45 0 -8 -7 -14 -15 -14 -27 0 -73 -29 -80 -50 -5 -17 -15 -20 -58 -20 -65 0 -114 -24 -145 -70 -21 -33 -84 -65 -104 -53 -22 12 -5 44 36 68 23 14 51 34 61 45 10 11 30 20 45 20 35 0 125 57 323 206 149 111 179 131 199 133 4 1 5 -20 1 -46z m1217 -723 c19 -4 54 -13 77 -20 38 -12 49 -11 108 9 71 23 253 48 279 38 24 -9 23 -174 -1 -216 -21 -36 -33 -39 -40 -11 -7 28 -16 25 -37 -11 -27 -46 -33 -155 -12 -211 22 -56 11 -107 -25 -125 -13 -7 -51 -13 -83 -13 -71 0 -131 26 -173 73 -39 44 -96 87 -117 87 -34 0 -74 30 -104 78 -18 26 -43 59 -58 73 -31 28 -54 70 -54 97 0 22 27 48 55 54 13 2 21 12 23 28 7 70 14 88 35 97 16 8 31 7 57 -4 19 -9 51 -19 70 -23z"/>',
          '<path d="M2337 1713 c-4 -3 -7 -15 -7 -25 0 -10 -18 -53 -40 -94 -22 -42 -40 -86 -40 -99 0 -22 2 -23 35 -14 19 6 54 28 78 50 23 22 66 53 95 70 29 17 51 36 49 43 -4 13 -124 74 -148 75 -9 1 -19 -2 -22 -6z"/>',
          '<path d="M1325 2436 c-17 -7 -39 -25 -48 -40 -10 -14 -24 -26 -32 -26 -21 0 -19 -43 11 -195 14 -71 28 -148 31 -170 3 -22 7 -42 8 -43 9 -10 43 12 62 40 13 18 39 50 58 70 35 37 44 58 24 58 -23 0 -139 123 -149 159 -16 59 -13 68 25 75 42 8 65 30 65 62 0 27 -11 29 -55 10z"/>',
          '<path d="M1090 2288 c-34 -24 -80 -55 -103 -69 -23 -14 -51 -39 -62 -56 -11 -17 -36 -39 -57 -48 -55 -26 -101 -79 -166 -195 -32 -58 -73 -128 -91 -156 -17 -27 -34 -68 -37 -90 -3 -21 -15 -57 -27 -79 -19 -36 -22 -61 -28 -248 -5 -178 -8 -209 -22 -220 -23 -16 -38 -99 -82 -452 -20 -159 -40 -294 -43 -300 -4 -5 -7 -74 -7 -153 -1 -130 1 -142 17 -142 12 0 18 8 18 24 0 13 7 29 15 36 8 7 13 16 10 20 -3 5 -1 11 5 15 5 3 10 12 10 18 0 8 -3 8 -9 -2 -6 -9 -9 -4 -9 15 0 16 6 38 14 49 13 19 14 24 14 45 0 6 4 10 9 10 6 0 8 -9 6 -20 -2 -11 0 -22 5 -25 5 -3 7 4 5 15 -2 11 4 24 13 31 16 10 16 10 0 5 -13 -4 -19 3 -23 28 -5 25 -1 41 19 70 14 20 28 58 31 84 12 96 16 110 34 127 11 9 28 15 38 13 15 -3 19 -17 24 -98 4 -52 12 -122 19 -155 8 -43 9 -69 1 -95 -5 -19 -13 -48 -16 -64 -6 -29 -31 -57 -100 -113 l-40 -32 458 0 457 -1 0 370 c0 361 0 370 -20 380 -18 10 -20 17 -14 63 4 29 9 55 13 59 4 4 3 47 -1 95 -4 49 -10 131 -14 183 -4 52 -11 105 -15 118 -5 13 -9 44 -9 68 0 25 -10 68 -22 95 -20 48 -20 51 -4 67 17 16 19 16 31 -3 46 -67 53 -67 100 -2 19 26 43 46 63 52 20 6 32 16 32 27 0 9 -34 53 -76 98 -70 72 -81 80 -115 80 -47 0 -56 -21 -39 -88 9 -34 9 -55 1 -74 -14 -37 -31 -36 -31 1 0 17 -5 33 -10 36 -6 4 -8 10 -6 13 4 7 -44 8 -51 2 -2 -2 -7 -3 -12 -4 -5 0 -21 -11 -35 -23 -19 -17 -26 -33 -26 -58 0 -19 -4 -35 -10 -35 -15 0 -12 107 3 120 6 5 23 18 36 28 22 17 22 19 6 35 -9 9 -27 17 -39 17 -16 0 -29 12 -44 39 -19 34 -23 58 -27 199 -5 168 -1 188 41 180 32 -6 41 -35 22 -68 -10 -17 -26 -43 -35 -60 -21 -35 -12 -49 39 -59 43 -9 50 -41 14 -65 -37 -23 -35 -61 4 -81 17 -9 30 -20 30 -26 0 -14 43 -28 56 -18 7 5 8 29 3 68 -3 32 -5 78 -4 102 3 37 -32 242 -51 302 -8 24 -14 22 -84 -25z m16 -774 c15 -44 23 -85 20 -99 -9 -34 -33 -55 -65 -55 -23 0 -31 7 -46 39 -17 39 -17 41 14 160 17 66 32 133 32 148 1 15 5 -5 10 -45 5 -39 20 -106 35 -148z m58 -481 c4 -9 6 -93 5 -186 l-1 -170 -23 29 c-18 23 -25 47 -31 113 -6 81 -1 181 12 214 8 22 30 22 38 0z"/>',
        '</g>',
        '<text x="50%" y="50%" text-anchor="middle" font-family="sans-serif" font-size="30" fill="#fff">',
          _fullDomainName,
        '</text>',
      '</svg>'
    ))));

    return string(abi.encodePacked("data:image/svg+xml;base64,", svgBase64Encoded));
  }

  function _randomHueNum(uint256 _tokenId) internal pure returns(uint256) {
    return uint256(keccak256(abi.encodePacked(_tokenId))) % 361;
  }

  // WRITE (OWNER)

  /// @notice Only metadata contract owner can call this function.
  function changeDescription(string calldata _description) external onlyOwner {
    description = _description;
    emit DescriptionChanged(msg.sender, _description);
  }
}